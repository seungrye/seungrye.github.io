<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Why my udp socket lost buffer"><meta itemprop=description content="When I connect via udp socket, I got buffer lost issue. and I don&rsquo;t know why.
Let&rsquo;s find out why.
Warning. I use heavyly broken english. I let you know. :P"><meta itemprop=datePublished content="2019-06-16T00:29:10+09:00"><meta itemprop=dateModified content="2019-06-20T00:00:00+00:00"><meta itemprop=wordCount content="918"><meta itemprop=keywords content="c++,boost,socket,udp,network,cpp,asio,boost-asio,"><meta property="og:title" content="Why my udp socket lost buffer"><meta property="og:description" content="When I connect via udp socket, I got buffer lost issue. and I don&rsquo;t know why.
Let&rsquo;s find out why.
Warning. I use heavyly broken english. I let you know. :P"><meta property="og:type" content="article"><meta property="og:url" content="https://handmade.iptime.org/posts/2019-06-16-udp-socket-connection-missed-buffer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-16T00:29:10+09:00"><meta property="article:modified_time" content="2019-06-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Why my udp socket lost buffer"><meta name=twitter:description content="When I connect via udp socket, I got buffer lost issue. and I don&rsquo;t know why.
Let&rsquo;s find out why.
Warning. I use heavyly broken english. I let you know. :P"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Why my udp socket lost buffer</title><link rel=stylesheet href=https://handmade.iptime.org/css/style.min.01f62fff7ba9e2888ea91c3cd0097e6a3f65d5d14863514fb3886453cca80599.css integrity="sha256-AfYv/3up4oiOqRw80Al+aj9l1dFIY1FPs4hkU8yoBZk=" crossorigin=anonymous><link rel=stylesheet href=https://handmade.iptime.org/css/tags.enji.min.47cbe1fce31495308f57e52b2bbcd9ede34060354313246f4e0331d7c4ece651.css integrity="sha256-R8vh/OMUlTCPV+UrK7zZ7eNAYDVDEyRvTgMx18Ts5lE=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://handmade.iptime.org>HANDMADE LOG</a></div><nav class="site-nav hide-in-mobile"><a href=https://handmade.iptime.org/posts/>Posts</a>
<a href=https://handmade.iptime.org/page/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/seungrye target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://instagram.com/_u/seungrye/ target=_blank rel="noopener me" title=Instagram><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://handmade.iptime.org/posts/>Posts</a></li><li><a href=https://handmade.iptime.org/page/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Jun 16, 2019</span></div><h1>Why my udp socket lost buffer</h1></header><div class=content><p>When I connect via udp socket, I got buffer lost issue. and I don&rsquo;t know why.</p><p>Let&rsquo;s find out why.</p><p>Warning. I use heavyly broken english. I let you know. :P</p><p>I use following code.</p><p>Of receiver.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;thread&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;cstdint&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;cassert&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;boost/make_shared.hpp&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;boost/asio.hpp&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;boost/bind.hpp&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>const</span> <span class=kt>int</span> <span class=n>port</span> <span class=o>=</span> <span class=mi>7003</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>on_recv</span><span class=p>(</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>socket</span><span class=o>&gt;</span> <span class=n>socket</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=o>&gt;</span> <span class=n>ep_from</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&gt;</span> <span class=n>buffer</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>system</span><span class=o>::</span><span class=n>error_code</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>ec</span><span class=p>,</span>
    <span class=n>std</span><span class=o>::</span><span class=n>size_t</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>bytes_tranferred</span><span class=p>);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;Enter&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>

    <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>io_service</span> <span class=n>io_service</span><span class=p>;</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>io_service</span><span class=o>::</span><span class=n>work</span> <span class=n>worker</span><span class=p>(</span><span class=n>io_service</span><span class=p>);</span>

    <span class=k>auto</span> <span class=kr>thread</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=p>(</span><span class=k>new</span> <span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=p>([</span><span class=o>&amp;</span><span class=n>io_service</span><span class=p>](){</span> <span class=n>io_service</span><span class=p>.</span><span class=n>run</span><span class=p>();</span> <span class=p>}));</span>
    <span class=n>assert</span><span class=p>(</span><span class=kr>thread</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>


    <span class=k>auto</span> <span class=n>socket</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>socket</span><span class=o>&gt;</span><span class=p>(</span>
        <span class=n>io_service</span><span class=p>,</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=p>(</span>
            <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>v4</span><span class=p>(),</span>
            <span class=n>port</span><span class=p>));</span>
    <span class=n>assert</span><span class=p>(</span><span class=n>socket</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>

    <span class=k>auto</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span> <span class=c1>// 10 byte length
</span><span class=c1></span>    <span class=n>assert</span><span class=p>(</span><span class=n>buffer</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>

    <span class=k>auto</span> <span class=n>ep_from</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=o>&gt;</span><span class=p>();</span>
    <span class=n>assert</span><span class=p>(</span><span class=n>ep_from</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>

    <span class=n>socket</span><span class=o>-&gt;</span><span class=n>async_receive_from</span><span class=p>(</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>buffer</span><span class=p>(</span><span class=o>*</span><span class=n>buffer</span><span class=p>),</span>
        <span class=o>*</span><span class=n>ep_from</span><span class=p>,</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=n>on_recv</span><span class=p>,</span>
            <span class=n>socket</span><span class=p>,</span>
            <span class=n>ep_from</span><span class=p>,</span>
            <span class=n>buffer</span><span class=p>,</span>
            <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>error</span><span class=p>,</span>
            <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>bytes_transferred</span><span class=p>));</span>

    <span class=kr>thread</span><span class=o>-&gt;</span><span class=n>join</span><span class=p>();</span>

    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;Exit&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>on_recv</span><span class=p>(</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>socket</span><span class=o>&gt;</span> <span class=n>socket</span><span class=p>,</span> <span class=c1>// local socket
</span><span class=c1></span>    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=o>&gt;</span> <span class=n>ep_from</span><span class=p>,</span> <span class=c1>// ep to response
</span><span class=c1></span>    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&gt;</span> <span class=n>buffer</span><span class=p>,</span> <span class=c1>// received buffer
</span><span class=c1></span>    <span class=n>boost</span><span class=o>::</span><span class=n>system</span><span class=o>::</span><span class=n>error_code</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>ec</span><span class=p>,</span>
    <span class=n>std</span><span class=o>::</span><span class=n>size_t</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>bytes_tranferred</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>ec</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=o>&lt;&lt;</span><span class=n>__func__</span><span class=o>&lt;&lt;</span><span class=s>&#34;() error code : &#34;</span><span class=o>&lt;&lt;</span><span class=n>ec</span><span class=p>.</span><span class=n>message</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
        <span class=k>return</span> <span class=p>;</span>
    <span class=p>}</span>

    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=n>__func__</span><span class=o>&lt;&lt;</span><span class=s>&#34;() recv &#34;</span><span class=o>&lt;&lt;</span><span class=n>bytes_tranferred</span><span class=o>&lt;&lt;</span><span class=s>&#34; bytes&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>

    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>message</span><span class=p>(</span><span class=n>buffer</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span> <span class=n>buffer</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>());</span>
    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=n>__func__</span><span class=o>&lt;&lt;</span><span class=s>&#34;() received message : &#34;</span><span class=o>&lt;&lt;</span><span class=n>message</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>


    <span class=n>socket</span><span class=o>-&gt;</span><span class=n>async_receive_from</span><span class=p>(</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>buffer</span><span class=p>(</span><span class=o>*</span><span class=n>buffer</span><span class=p>),</span>
        <span class=o>*</span><span class=n>ep_from</span><span class=p>,</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=n>on_recv</span><span class=p>,</span>
            <span class=n>socket</span><span class=p>,</span>
            <span class=n>ep_from</span><span class=p>,</span>
            <span class=n>buffer</span><span class=p>,</span>
            <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>error</span><span class=p>,</span>
            <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>bytes_transferred</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div><p>Of sender.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;thread&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;cstdint&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;cassert&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;boost/make_shared.hpp&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;boost/asio.hpp&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;boost/bind.hpp&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>const</span> <span class=kt>int</span> <span class=n>port</span> <span class=o>=</span> <span class=mi>7003</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>on_sent</span><span class=p>(</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=o>&gt;</span> <span class=n>ep_from</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&gt;</span> <span class=n>buffer</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>system</span><span class=o>::</span><span class=n>error_code</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>ec</span><span class=p>,</span>
    <span class=n>std</span><span class=o>::</span><span class=n>size_t</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>bytes_tranferred</span><span class=p>);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;Enter&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>

    <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>io_service</span> <span class=n>io_service</span><span class=p>;</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>io_service</span><span class=o>::</span><span class=n>work</span> <span class=n>worker</span><span class=p>(</span><span class=n>io_service</span><span class=p>);</span>

    <span class=k>auto</span> <span class=kr>thread</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=p>(</span><span class=k>new</span> <span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=p>([</span><span class=o>&amp;</span><span class=n>io_service</span><span class=p>](){</span> <span class=n>io_service</span><span class=p>.</span><span class=n>run</span><span class=p>();</span> <span class=p>}));</span>
    <span class=n>assert</span><span class=p>(</span><span class=kr>thread</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>


    <span class=k>auto</span> <span class=n>socket</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>socket</span><span class=o>&gt;</span><span class=p>(</span>
        <span class=n>io_service</span><span class=p>,</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=p>());</span>
    <span class=n>assert</span><span class=p>(</span><span class=n>socket</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>

    <span class=k>auto</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&gt;</span><span class=p>();</span>
    <span class=n>assert</span><span class=p>(</span><span class=n>buffer</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>

    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>hello</span> <span class=o>=</span> <span class=s>&#34;HELLO UDP WORLD&#34;</span><span class=p>;</span>
    <span class=n>buffer</span><span class=o>-&gt;</span><span class=n>assign</span><span class=p>(</span><span class=n>hello</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>hello</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>

    <span class=k>auto</span> <span class=n>ep_from</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=o>&gt;</span><span class=p>(</span>
        <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>v4</span><span class=p>(),</span>
        <span class=n>port</span><span class=p>);</span>
    <span class=n>assert</span><span class=p>(</span><span class=n>ep_from</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>

    <span class=n>socket</span><span class=o>-&gt;</span><span class=n>async_send_to</span><span class=p>(</span>
       <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>buffer</span><span class=p>(</span><span class=o>*</span><span class=n>buffer</span><span class=p>),</span>
       <span class=o>*</span><span class=n>ep_from</span><span class=p>,</span>
       <span class=n>boost</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=n>on_sent</span><span class=p>,</span>
           <span class=n>ep_from</span><span class=p>,</span>
           <span class=n>buffer</span><span class=p>,</span> <span class=c1>// prevent to loose reference count
</span><span class=c1></span>           <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>error</span><span class=p>,</span>
           <span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>bytes_transferred</span><span class=p>));</span>

    <span class=kr>thread</span><span class=o>-&gt;</span><span class=n>join</span><span class=p>();</span>

    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;Exit&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>on_sent</span><span class=p>(</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>boost</span><span class=o>::</span><span class=n>asio</span><span class=o>::</span><span class=n>ip</span><span class=o>::</span><span class=n>udp</span><span class=o>::</span><span class=n>endpoint</span><span class=o>&gt;</span> <span class=n>ep_from</span><span class=p>,</span> <span class=c1>// ep to response
</span><span class=c1></span>    <span class=n>boost</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;&gt;</span> <span class=n>buffer</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>system</span><span class=o>::</span><span class=n>error_code</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>ec</span><span class=p>,</span>
    <span class=n>std</span><span class=o>::</span><span class=n>size_t</span> <span class=k>const</span><span class=o>&amp;</span> <span class=n>bytes_tranferred</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>ec</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=o>&lt;&lt;</span><span class=n>__func__</span><span class=o>&lt;&lt;</span><span class=s>&#34;() error code : &#34;</span><span class=o>&lt;&lt;</span><span class=n>ec</span><span class=p>.</span><span class=n>message</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
        <span class=k>return</span> <span class=p>;</span>
    <span class=p>}</span>

    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=n>__func__</span><span class=o>&lt;&lt;</span><span class=s>&#34;() sent &#34;</span><span class=o>&lt;&lt;</span><span class=n>bytes_tranferred</span><span class=o>&lt;&lt;</span><span class=s>&#34; bytes&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>And, I got following result.</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ ./asio_udp_receiver_sample
Enter
on_recv<span class=o>()</span> recv <span class=m>10</span> bytes
on_recv<span class=o>()</span> received message : HELLO UDP 
</code></pre></div><p>As you can see, I got only half of buffer compare to original sent buffer. ( Where is the <code>WORLD</code> string?? :$ )
Of course, I set receiving buffer size to very small. but I read buffer repeatedly.
And still, got only first small buffer of string.</p><p>So, why is it??</p><p>In <code>UNIX Network Programming: The socket networking API</code> book has clue.</p><pre><code>OS BSD-derived systems, when a UDP datagram arrives that is larger than the 
application's buffer, recvmsg sets the MSG_TRUNC flag in the msg_flags member
of the msghdr structure (Figure 14.7). All Berkeley-derived implementations 
that support the msghdr structure with the msg_flags member provide this 
notification.

Unfortunately, not all implementations handle a larger-than-expected UDP 
datagram in this fashion. There are three possible scenarios:
 1. Discard the excess bytes and return the MSG_TRUNC flag to the application. 
    This requires that the application call recvmsg to receive the flag.
 2. Discard the excess bytes, but do not tell the application.
 3. Keep the excess bytes and return them in subsequent read operations on the socket.

 Since there are such variations in how implementations handle datagrams that 
 are larger than the application's receive buffer, one way to detect the 
 problem is to always allocate an application buffer that is one byte greater 
 than the largest datagram the application should ever receive. 
 If a diagram is ever received whose length equals this buffer, consider it 
 an error.
</code></pre><p>So, there are 3 possible scenarios, and the third is not possible.
cause I already add subsequent read operation, but still has issue.</p><p>Then, let&rsquo;s find out <code>MSG_TRUNC</code> flag on the <code>msg_flags</code> that member of <code>msghdr</code> structure.</p><p>First of all, what <code>MSG_TRUNC</code> value is it??</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ cat /usr/include/bits/socket.h <span class=p>|</span> grep MSG_TRUNC
    <span class=nv>MSG_TRUNC</span>           <span class=o>=</span> 0x20,
<span class=c1>#define MSG_TRUNC       MSG_TRUNC</span>
</code></pre></div><p>I found the <code>msg_flags</code> variable on <code>boost::asio::detail::socket_ops::recvfrom(...)</code>.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>signed_size_type</span> <span class=nf>recvfrom</span><span class=p>(</span><span class=n>socket_type</span> <span class=n>s</span><span class=p>,</span> <span class=n>buf</span><span class=o>*</span> <span class=n>bufs</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>count</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>socket_addr_type</span><span class=o>*</span> <span class=n>addr</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>size_t</span><span class=o>*</span> <span class=n>addrlen</span><span class=p>,</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>system</span><span class=o>::</span><span class=n>error_code</span><span class=o>&amp;</span> <span class=n>ec</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>clear_last_error</span><span class=p>();</span>
  <span class=n>msghdr</span> <span class=n>msg</span> <span class=o>=</span> <span class=n>msghdr</span><span class=p>();</span>
  <span class=n>init_msghdr_msg_name</span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=n>msg_name</span><span class=p>,</span> <span class=n>addr</span><span class=p>);</span>
  <span class=n>msg</span><span class=p>.</span><span class=n>msg_namelen</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=o>*</span><span class=n>addrlen</span><span class=p>);</span>
  <span class=n>msg</span><span class=p>.</span><span class=n>msg_iov</span> <span class=o>=</span> <span class=n>bufs</span><span class=p>;</span>
  <span class=n>msg</span><span class=p>.</span><span class=n>msg_iovlen</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>count</span><span class=p>);</span>
  <span class=n>signed_size_type</span> <span class=n>result</span> <span class=o>=</span> <span class=n>error_wrapper</span><span class=p>(</span><span class=o>::</span><span class=n>recvmsg</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span> <span class=n>flags</span><span class=p>),</span> <span class=n>ec</span><span class=p>);</span>
<span class=o>&gt;</span> <span class=o>*</span><span class=n>addrlen</span> <span class=o>=</span> <span class=n>msg</span><span class=p>.</span><span class=n>msg_namelen</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
    <span class=n>ec</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>system</span><span class=o>::</span><span class=n>error_code</span><span class=p>();</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</code></pre></div><p>And I check <code>msg.msg_flags</code> after returned of <code>::recvmsg(s, &msg, flags)</code>.</p><p>It is 0x20.</p><pre><code class=language-lldb data-lang=lldb>(lldb) bt
* thread #2, name = 'asio_udp_receiv', stop reason = step over
  * frame #0: 0x0000555555564780 asio_udp_receiver_sample1`boost::asio::detail::socket_ops::recvfrom(s=6, bufs=0x00007ffff7a6db10, count=1, flags=0, addr=0x000055555559983c, addrlen=0x00007ffff7a6db00, ec=0x0000555555599880) at socket_ops.ipp:941:18
    frame #1: 0x0000555555564839 asio_udp_receiver_sample1`boost::asio::detail::socket_ops::non_blocking_recvfrom(s=6, bufs=0x00007ffff7a6db10, count=1, flags=0, addr=0x000055555559983c, addrlen=0x00007ffff7a6db00, ec=0x0000555555599880, bytes_transferred=0x0000555555599890) at socket_ops.ipp:1015:50
    frame #2: 0x000055555556fda0 asio_udp_receiver_sample1`boost::asio::detail::reactive_socket_recvfrom_op_base&lt;boost::asio::mutable_buffers_1, boost::asio::ip::basic_endpoint&lt;boost::asio::ip::udp&gt; &gt;::do_perform(base=0x0000555555599860) at reactive_socket_recvfrom_op.hpp:57:54
    frame #3: 0x0000555555560de9 asio_udp_receiver_sample1`boost::asio::detail::reactor_op::perform(this=0x0000555555599860) at reactor_op.hpp:44:25
    frame #4: 0x0000555555562da3 asio_udp_receiver_sample1`boost::asio::detail::epoll_reactor::descriptor_state::perform_io(this=0x0000555555599700, events=1) at epoll_reactor.ipp:743:52
    frame #5: 0x0000555555562ed3 asio_udp_receiver_sample1`boost::asio::detail::epoll_reactor::descriptor_state::do_complete(owner=0x00005555555992d0, base=0x0000555555599700, ec=0x00007ffff7a6ddd0, bytes_transferred=1) at epoll_reactor.ipp:774:52
    frame #6: 0x000055555555f4c8 asio_udp_receiver_sample1`boost::asio::detail::scheduler_operation::complete(this=0x0000555555599700, owner=0x00005555555992d0, ec=0x00007ffff7a6ddd0, bytes_transferred=1) at scheduler_operation.hpp:40:10
    frame #7: 0x0000555555563b70 asio_udp_receiver_sample1`boost::asio::detail::scheduler::do_run_one(this=0x00005555555992d0, lock=0x00007ffff7a6dd30, this_thread=0x00007ffff7a6dd60, ec=0x00007ffff7a6ddd0) at scheduler.ipp:401:20
    frame #8: 0x00005555555635b5 asio_udp_receiver_sample1`boost::asio::detail::scheduler::run(this=0x00005555555992d0, ec=0x00007ffff7a6ddd0) at scheduler.ipp:154:20
    frame #9: 0x000055555556406a asio_udp_receiver_sample1`boost::asio::io_context::run(this=0x00007fffffffebe0) at io_context.ipp:62:27
    frame #10: 0x000055555555b7a5 asio_udp_receiver_sample1`operator(__closure=0x0000555555599418) at main.cpp:27:92
    frame #11: 0x000055555555c7d9 asio_udp_receiver_sample1`std::__invoke_impl&lt;void, main()::&lt;lambda()&gt; &gt;((null)=__invoke_other @ 0x00007ffff7a6de40, __f=0x0000555555599418)&gt; &amp;&amp;) at invoke.h:60:36
    frame #12: 0x000055555555c77a asio_udp_receiver_sample1`std::__invoke&lt;main()::&lt;lambda()&gt; &gt;(__fn=0x0000555555599418)&gt; &amp;&amp;) at invoke.h:95:40
    frame #13: 0x000055555555c718 asio_udp_receiver_sample1`std:ðŸ§µ:_Invoker&lt;std::tuple&lt;main()::&lt;lambda()&gt; &gt; &gt;::_M_invoke&lt;0&gt;(this=0x0000555555599418, (null)=_Index_tuple&lt;0&gt; @ 0x00007ffff7a6de90) const at thread:244:26
    frame #14: 0x000055555555c6d9 asio_udp_receiver_sample1`std:ðŸ§µ:_Invoker&lt;std::tuple&lt;main()::&lt;lambda()&gt; &gt; &gt;::operator(this=0x0000555555599418)() const at thread:251:31
    frame #15: 0x000055555555c6ae asio_udp_receiver_sample1`std:ðŸ§µ:_State_impl&lt;std:ðŸ§µ:_Invoker&lt;std::tuple&lt;main()::&lt;lambda()&gt; &gt; &gt; &gt;::_M_run(this=0x0000555555599410) const at thread:195:13
    frame #16: 0x00007ffff7e65cd4 libstdc++.so.6`execute_native_thread_routine at thread.cc:80:18
    frame #17: 0x00007ffff7f8857f libpthread.so.0`start_thread + 239
    frame #18: 0x00007ffff7b6ff13 libc.so.6`__GI___clone + 67
(lldb) p/x msg.msg_flags
(int) $8 = 0x00000020
</code></pre><p>So, In my case. I am in <code>1. Discard the excess bytes and return the MSG_TRUNC flag to the application.</code> scenario.</p><p>Too bad that boost asio library did not notice this kind of situation. or my bad :P</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://handmade.iptime.org/tags/c++>c++</a></span><span class=tag><a href=https://handmade.iptime.org/tags/boost>boost</a></span><span class=tag><a href=https://handmade.iptime.org/tags/socket>socket</a></span><span class=tag><a href=https://handmade.iptime.org/tags/udp>udp</a></span><span class=tag><a href=https://handmade.iptime.org/tags/network>network</a></span><span class=tag><a href=https://handmade.iptime.org/tags/cpp>cpp</a></span><span class=tag><a href=https://handmade.iptime.org/tags/asio>asio</a></span><span class=tag><a href=https://handmade.iptime.org/tags/boost-asio>boost-asio</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>918 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2019-06-15 15:29 +0000</p></footer></article><div class="post-nav thin"><a class=next-post href=https://handmade.iptime.org/posts/2019-06-17-no-default-toolchain-configured-on-rls/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>No default toolchain configured error when run rustc</span></a>
<a class=prev-post href=https://handmade.iptime.org/posts/2019-06-07-popupmenu-eample-on-flutter/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>PopupMenu example on Flutter</span></a></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//handmade-iptime-org.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://handmade.iptime.org>Enji Ahn</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://handmade.iptime.org/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://handmade.iptime.org/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>